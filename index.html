<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#5B4FE9">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TickTock Tales">
<meta name="description" content="Fun clock-reading game for kids ages 5‚Äì9">
<link rel="manifest" href="https://lamranimarouane-sketch.github.io/ticktocktales/manifest.json">
<link rel="apple-touch-icon" href="icon-512.png">
<title>TickTock Tales üïê</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#FFF9F0;--primary:#5B4FE9;--primary-light:#8B82F0;
    --secondary:#FF6B6B;--accent:#FFD93D;--green:#6BCB77;--teal:#4ECDC4;
    --card-bg:#FFFFFF;--text:#2D2B55;--text-light:#8884C0;
    --shadow:0 8px 32px rgba(91,79,233,0.15);--radius:24px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Fredoka',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
  body::before,body::after{content:'';position:fixed;border-radius:50%;filter:blur(80px);opacity:.15;pointer-events:none;z-index:0;}
  body::before{width:400px;height:400px;background:var(--primary);top:-100px;left:-100px;animation:float1 8s ease-in-out infinite;}
  body::after{width:300px;height:300px;background:var(--secondary);bottom:-80px;right:-80px;animation:float2 10s ease-in-out infinite;}
  @keyframes float1{0%,100%{transform:translate(0,0)}50%{transform:translate(40px,30px)}}
  @keyframes float2{0%,100%{transform:translate(0,0)}50%{transform:translate(-30px,-40px)}}
  #app{position:relative;z-index:1;max-width:480px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
  .screen{display:none;flex-direction:column;flex:1;padding:24px 20px;animation:screenIn .4s cubic-bezier(.34,1.56,.64,1);}
  .screen.active{display:flex;}
  @keyframes screenIn{from{opacity:0;transform:translateY(30px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

  /* HOME */
  .home-header{text-align:center;margin-bottom:20px;padding-top:12px;}
  .app-logo{font-family:'Fredoka One',cursive;font-size:42px;color:var(--primary);line-height:1;text-shadow:3px 3px 0 var(--primary-light);letter-spacing:-1px;}
  .app-tagline{font-size:15px;color:var(--text-light);margin-top:4px;}
  .clock-emoji-spin{display:block;font-size:60px;margin:0 auto 10px;animation:spin-slow 10s linear infinite;}
  @keyframes spin-slow{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  .level-grid{display:grid;gap:13px;margin-bottom:18px;}
  .level-card{background:var(--card-bg);border-radius:var(--radius);padding:16px 18px;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow);cursor:pointer;border:3px solid transparent;transition:all .25s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
  .level-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity .2s;}
  .level-card:hover{transform:translateY(-4px) scale(1.02);}
  .level-card:active{transform:scale(.98);}
  .level-card.easy{border-color:var(--green);}
  .level-card.easy::before{background:linear-gradient(135deg,rgba(107,203,119,.1),transparent);}
  .level-card.medium{border-color:var(--accent);}
  .level-card.medium::before{background:linear-gradient(135deg,rgba(255,217,61,.1),transparent);}
  .level-card.hard{border-color:var(--secondary);}
  .level-card.hard::before{background:linear-gradient(135deg,rgba(255,107,107,.1),transparent);}
  .level-card:hover::before{opacity:1;}

  .level-icon{width:54px;height:54px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;}
  .easy .level-icon{background:rgba(107,203,119,.2);}
  .medium .level-icon{background:rgba(255,217,61,.2);}
  .hard .level-icon{background:rgba(255,107,107,.2);}
  .level-info h3{font-size:20px;font-weight:700;color:var(--text);}
  .level-info p{font-size:13px;color:var(--text-light);margin-top:2px;}
  .level-stars{margin-left:auto;font-size:15px;}
  .home-footer{display:flex;gap:12px;margin-top:auto;padding-top:6px;}

  /* BUTTONS */
  .btn{font-family:'Fredoka',sans-serif;font-size:18px;font-weight:600;padding:13px 22px;border-radius:16px;border:none;cursor:pointer;transition:all .2s cubic-bezier(.34,1.56,.64,1);display:inline-flex;align-items:center;justify-content:center;gap:8px;position:relative;overflow:hidden;}
  .btn::after{content:'';position:absolute;inset:0;background:white;opacity:0;transition:opacity .15s;}
  .btn:active::after{opacity:.15;}
  .btn:hover{transform:translateY(-2px);}
  .btn:active{transform:scale(.97);}
  .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:white;box-shadow:0 4px 20px rgba(91,79,233,.4);flex:1;}
  .btn-secondary{background:var(--card-bg);color:var(--text);box-shadow:var(--shadow);flex:1;}
  /* FREE PLAY */
  .quiz-header{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
  .back-btn{width:44px;height:44px;border-radius:12px;border:none;background:var(--card-bg);box-shadow:var(--shadow);cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
  .back-btn:hover{transform:scale(1.1);}
  .score-strip{flex:1;background:var(--card-bg);border-radius:12px;padding:8px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow);}
  .score-val{font-size:19px;font-weight:700;color:var(--primary);}
  .streak-val{font-size:15px;color:var(--secondary);font-weight:600;}
  .progress-bar-wrap{background:rgba(91,79,233,.1);border-radius:99px;height:10px;margin-bottom:18px;overflow:hidden;}
  .progress-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--primary),var(--primary-light));transition:width .5s ease;}
  .question-card{background:var(--card-bg);border-radius:var(--radius);padding:18px 22px;box-shadow:var(--shadow);margin-bottom:14px;text-align:center;}
  .question-label{font-size:15px;color:var(--text-light);margin-bottom:5px;}
  .question-text{font-family:'Fredoka One',cursive;font-size:22px;color:var(--text);line-height:1.2;}
  .clock-wrap{display:flex;justify-content:center;margin:10px 0 18px;}
  canvas#clock{filter:drop-shadow(0 10px 28px rgba(91,79,233,.2));}
  .choices-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:8px;}
  .btn-choice-grid{background:var(--card-bg);color:var(--text);box-shadow:0 4px 16px rgba(0,0,0,.08);border:3px solid transparent;font-size:21px;font-family:'Fredoka One',cursive;padding:16px 10px;border-radius:16px;cursor:pointer;transition:all .2s;text-align:center;}
  .btn-choice-grid:hover{border-color:var(--primary-light);transform:scale(1.04);}
  .btn-choice-grid.correct{background:linear-gradient(135deg,#6BCB77,#4CAF50);color:white;border-color:transparent;animation:correctPop .4s cubic-bezier(.34,1.56,.64,1);}
  .btn-choice-grid.wrong{background:linear-gradient(135deg,#FF6B6B,#f44336);color:white;border-color:transparent;animation:wrongShake .4s ease;}
  @keyframes correctPop{0%{transform:scale(1)}50%{transform:scale(1.07)}100%{transform:scale(1)}}
  @keyframes wrongShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}

  /* TOAST */
  .feedback-toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);background:white;padding:13px 26px;border-radius:99px;font-size:19px;font-weight:700;box-shadow:0 8px 32px rgba(0,0,0,.15);z-index:100;transition:transform .4s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;}
  .feedback-toast.show{transform:translateX(-50%) translateY(0);}
  .feedback-toast.correct-fb{color:var(--green);border:3px solid var(--green);}
  .feedback-toast.wrong-fb{color:var(--secondary);border:3px solid var(--secondary);}
  #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:200;}

  /* RESULT */
  .result-content{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;}
  .result-emoji{font-size:78px;animation:bounceIn .6s cubic-bezier(.34,1.56,.64,1);margin-bottom:10px;}
  @keyframes bounceIn{from{transform:scale(0) rotate(-15deg)}to{transform:scale(1) rotate(0deg)}}
  .result-title{font-family:'Fredoka One',cursive;font-size:34px;color:var(--primary);text-shadow:2px 2px 0 var(--primary-light);margin-bottom:4px;}
  .result-score{font-size:58px;font-family:'Fredoka One',cursive;color:var(--accent);text-shadow:3px 3px 0 rgba(0,0,0,.1);margin:10px 0;}
  .result-stats{display:flex;gap:16px;margin:10px 0 20px;}
  .stat-pill{background:var(--card-bg);padding:10px 16px;border-radius:16px;box-shadow:var(--shadow);text-align:center;}
  .stat-pill .val{font-size:21px;font-weight:700;color:var(--primary);}
  .stat-pill .lbl{font-size:12px;color:var(--text-light);}
  .badge-unlocked{background:linear-gradient(135deg,#FFD700,#FFA500);padding:13px 18px;border-radius:18px;margin-bottom:18px;display:flex;align-items:center;gap:12px;animation:badgePop .5s .5s cubic-bezier(.34,1.56,.64,1) both;box-shadow:0 8px 24px rgba(255,165,0,.3);}
  @keyframes badgePop{from{transform:scale(0)}to{transform:scale(1)}}
  .badge-unlocked span{font-size:30px;}
  .badge-text h4{font-size:16px;color:white;font-weight:700;}
  .badge-text p{font-size:13px;color:rgba(255,255,255,.85);}

  /* PARENT */
  .parent-header{display:flex;align-items:center;gap:12px;margin-bottom:22px;}
  .parent-title{font-family:'Fredoka One',cursive;font-size:24px;color:var(--primary);}
  .stat-card{background:var(--card-bg);border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow);margin-bottom:13px;}
  .stat-card h4{font-size:11px;color:var(--text-light);margin-bottom:5px;text-transform:uppercase;letter-spacing:1px;}
  .stat-card .big-val{font-family:'Fredoka One',cursive;font-size:36px;color:var(--primary);line-height:1;}
  .stat-card .sub-val{font-size:13px;color:var(--text-light);margin-top:3px;}
  .accuracy-bar{height:12px;border-radius:99px;background:rgba(91,79,233,.1);margin-top:10px;overflow:hidden;}
  .accuracy-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--green),var(--teal));transition:width 1s ease;}
  .badge-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-top:7px;}
  .badge-item{background:var(--card-bg);border-radius:13px;padding:12px 5px;text-align:center;box-shadow:var(--shadow);filter:grayscale(1) opacity(.4);transition:all .3s;}
  .badge-item.earned{filter:none;border:2px solid var(--accent);transform:scale(1.05);}
  .badge-item .b-emoji{font-size:26px;}
  .badge-item .b-name{font-size:11px;color:var(--text-light);margin-top:3px;}

  /* FREE PLAY */
  canvas#clockFree{cursor:grab;filter:drop-shadow(0 10px 28px rgba(91,79,233,.2));}

  /* LANG */
  .lang-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px;}
  .lang-btn{padding:7px 13px;background:var(--card-bg);border:2px solid transparent;border-radius:11px;font-family:'Fredoka',sans-serif;font-size:13px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.08);}
  .lang-btn.active{border-color:var(--primary);color:var(--primary);background:rgba(91,79,233,.08);}
  .lang-btn:hover{transform:scale(1.05);}
  @media(max-width:360px){.app-logo{font-size:34px;}.choices-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div class="feedback-toast" id="feedbackToast"></div>

<div id="app">
  <!-- HOME -->
  <div class="screen active" id="screen-home">
    <div class="home-header">
      <span class="clock-emoji-spin">üïê</span>
      <div class="app-logo">TickTock Tales</div>
      <div class="app-tagline" id="home-tagline">Learn to tell time ‚Äî it's fun! ‚≠ê</div>
    </div>
    <div class="lang-row">
      <button class="lang-btn active" onclick="setLang('en',this)">üá¨üáß EN</button>
      <button class="lang-btn" onclick="setLang('fr',this)">üá´üá∑ FR</button>
      <button class="lang-btn" onclick="setLang('es',this)">üá™üá∏ ES</button>
      <button class="lang-btn" onclick="setLang('ar',this)">üá∏üá¶ AR</button>
    </div>
    <div class="level-grid">
      <div class="level-card easy" onclick="startGame('easy')">
        <div class="level-icon">üòä</div>
        <div class="level-info"><h3 id="lbl-easy">Easy</h3><p id="lbl-easy-desc">Whole hours only</p></div>
        <div class="level-stars">‚≠ê</div>
      </div>
      <div class="level-card medium" id="card-medium" onclick="startGame('medium')">
        <div class="level-icon">ü§î</div>
        <div class="level-info"><h3 id="lbl-medium">Medium</h3><p id="lbl-medium-desc">Half &amp; quarter hours</p></div>
        <div class="level-stars">‚≠ê‚≠ê</div>
      </div>
      <div class="level-card hard" id="card-hard" onclick="startGame('hard')">
        <div class="level-icon">üî•</div>
        <div class="level-info"><h3 id="lbl-hard">Hard</h3><p id="lbl-hard-desc">Any minute ‚Ä¢ Timed!</p></div>
        <div class="level-stars">‚≠ê‚≠ê‚≠ê</div>
      </div>
    </div>
    <div class="home-footer">
      <button class="btn btn-secondary" onclick="showParent()">üë®‚Äçüë©‚Äçüëß <span id="lbl-parent">Parent</span></button>
      <button class="btn btn-primary" onclick="showFreePlay()">üïê <span id="lbl-practice">Practice</span></button>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="screen" id="screen-quiz">
    <div class="quiz-header">
      <button class="back-btn" onclick="goHome()">‚Üê</button>
      <div class="score-strip">
        <span class="score-val">‚≠ê <span id="scoreDisplay">0</span></span>
        <span class="streak-val">üî• <span id="streakDisplay">0</span></span>
      </div>
    </div>
    <div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBar" style="width:0%"></div></div>
    <div class="question-card">
      <div class="question-label" id="questionLabel">Question 1 of 10</div>
      <div class="question-text" id="questionText">What time does the clock show?</div>
    </div>
    <div class="clock-wrap"><canvas id="clock" width="240" height="240"></canvas></div>
    <div id="choicesContainer"></div>
    <div id="nextBtnWrap" style="display:none">
      <button class="btn btn-primary" style="width:100%" onclick="nextQuestion()" id="nextBtn">Next ‚ûú</button>
    </div>
  </div>

  <!-- FREE PLAY -->
  <div class="screen" id="screen-freeplay">
    <div class="quiz-header">
      <button class="back-btn" onclick="goHome()">‚Üê</button>
      <div style="font-size:19px;font-weight:700">üïê <span id="lbl-fp-title">Free Practice</span></div>
    </div>
    <div class="question-card" style="text-align:center">
      <div class="question-text" id="lbl-fp-drag">Drag the hands to any time!</div>
    </div>
    <div class="clock-wrap"><canvas id="clockFree" width="270" height="270"></canvas></div>
    <div class="question-card" style="text-align:center;margin-top:0">
      <div style="font-size:46px;font-family:'Fredoka One',cursive;color:var(--primary)" id="freeTimeDisplay">12:00</div>
      <div style="font-size:14px;color:var(--text-light);margin-top:4px" id="freeTimeWords">Twelve o'clock</div>
    </div>
  </div>

  <!-- RESULT -->
  <div class="screen" id="screen-result">
    <div class="result-content">
      <div class="result-emoji" id="resultEmoji">üéâ</div>
      <div class="result-title" id="resultTitle">Amazing!</div>
      <div class="result-score" id="resultScore">0 pts</div>
      <div class="result-stats">
        <div class="stat-pill"><div class="val" id="resultAccuracy">-</div><div class="lbl" id="res-lbl-acc">Accuracy</div></div>
        <div class="stat-pill"><div class="val" id="resultStreak">-</div><div class="lbl" id="res-lbl-streak">Best Streak</div></div>
        <div class="stat-pill"><div class="val" id="resultQuestions">-</div><div class="lbl" id="res-lbl-answered">Answered</div></div>
      </div>
      <div class="badge-unlocked" id="badgeUnlocked" style="display:none">
        <span id="badgeEmoji">üèÖ</span>
        <div class="badge-text"><h4 id="res-badge-hdr">Badge Unlocked!</h4><p id="badgeName">First Steps</p></div>
      </div>
      <div style="display:flex;gap:12px;width:100%">
        <button class="btn btn-secondary" onclick="goHome()">üè† <span id="res-btn-home">Home</span></button>
        <button class="btn btn-primary" onclick="playAgain()">üîÑ <span id="res-btn-again">Play Again</span></button>
      </div>
    </div>
  </div>

  <!-- PARENT -->
  <div class="screen" id="screen-parent">
    <div class="parent-header">
      <button class="back-btn" onclick="goHome()">‚Üê</button>
      <div class="parent-title" id="parent-title">üë®‚Äçüë©‚Äçüëß Parent Dashboard</div>
    </div>
    <div class="stat-card">
      <h4 id="p-lbl-score">TOTAL SCORE</h4>
      <div class="big-val" id="pTotalScore">0</div>
      <div class="sub-val" id="p-lbl-score-sub">points earned</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:13px">
      <div class="stat-card" style="margin-bottom:0"><h4 id="p-lbl-games">GAMES PLAYED</h4><div class="big-val" id="pGames">0</div></div>
      <div class="stat-card" style="margin-bottom:0"><h4 id="p-lbl-streak">BEST STREAK</h4><div class="big-val" id="pStreak">0</div><div class="sub-val">üî• <span id="p-lbl-row">in a row</span></div></div>
    </div>
    <div class="stat-card">
      <h4 id="p-lbl-acc">OVERALL ACCURACY</h4>
      <div class="big-val" id="pAccuracy">0%</div>
      <div class="accuracy-bar"><div class="accuracy-fill" id="pAccuracyBar" style="width:0%"></div></div>
    </div>
    <div class="stat-card"><h4 id="p-lbl-badges">BADGES EARNED</h4><div class="badge-grid" id="badgeGrid"></div></div>
    <button class="btn" style="width:100%;margin-top:13px;background:rgba(255,107,107,.1);color:var(--secondary)" onclick="resetProgress()">
      üóëÔ∏è <span id="p-btn-reset">Reset Progress</span>
    </button>
  </div>
</div>

<script>
// =====================================================================
// FULL LOCALIZATION ‚Äî all screens: home, quiz, result, parent
// =====================================================================
const LANGS = {
  en:{
    tagline:"Learn to tell time ‚Äî it's fun! ‚≠ê",
    easy:'Easy',easyDesc:'Whole hours only',
    medium:'Medium',mediumDesc:'Half & quarter hours',
    hard:'Hard',hardDesc:'Any minute ‚Ä¢ Timed!',
    parent:'Parent',practice:'Practice',
    fpTitle:'Free Practice',fpDrag:'Drag the hands to any time!',
    whatTime:'What time does the clock show?',
    correct:['Great job! üéâ','Amazing! ‚≠ê','You got it! üôå','Fantastic! üåü','Brilliant! üí°'],
    wrong:['Try again! üí™','Almost! Keep going!','You can do it! ü§©','So close! üéØ'],
    q:'Question',of:'of',
    resAcc:'Accuracy',resStreak:'Best Streak',resAnswered:'Answered',
    resBadgeHdr:'Badge Unlocked!',resHome:'Home',resAgain:'Play Again',
    resTitles:['Keep Practicing!','Good Effort!','Great Job!','Amazing!','Perfect! üåü'],
    resPts:'pts',
    parentTitle:'üë®‚Äçüë©‚Äçüëß Parent Dashboard',
    pScore:'TOTAL SCORE',pScoreSub:'points earned',
    pGames:'GAMES PLAYED',pStreak:'BEST STREAK',pRow:'in a row',
    pAcc:'OVERALL ACCURACY',pBadges:'BADGES EARNED',pReset:'Reset Progress',
    nextQ:'Next ‚ûú',seeResults:'See Results',
    badgeNames:{first:'First Steps',streak3:'On Fire',perfect:'Perfect!',hard:'Champion',medium:'Scholar',easy:'Starter'},
  },
  fr:{
    tagline:"Apprends l'heure ‚Äî c'est amusant ! ‚≠ê",
    easy:'Facile',easyDesc:'Heures enti√®res seulement',
    medium:'Moyen',mediumDesc:"Demies et quarts d'heure",
    hard:'Difficile',hardDesc:'Toutes les minutes ‚Ä¢ Chrono !',
    parent:'Parents',practice:'Pratique',
    fpTitle:'Pratique libre',fpDrag:'Fais glisser les aiguilles !',
    whatTime:"Quelle heure indique l'horloge ?",
    correct:['Bravo ! üéâ','Super ! ‚≠ê',"C'est √ßa ! üôå",'Fantastique ! üåü','Brillant ! üí°'],
    wrong:['Essaie encore ! üí™','Presque ! Continue !','Tu peux le faire ! ü§©','Tr√®s proche ! üéØ'],
    q:'Question',of:'sur',
    resAcc:'Pr√©cision',resStreak:'Meilleure S√©rie',resAnswered:'R√©pondus',
    resBadgeHdr:'Badge D√©bloqu√© !',resHome:'Accueil',resAgain:'Rejouer',
    resTitles:['Continue !','Bon effort !','Super boulot !','Incroyable !','Parfait ! üåü'],
    resPts:'pts',
    parentTitle:'üë®‚Äçüë©‚Äçüëß Tableau de bord Parents',
    pScore:'SCORE TOTAL',pScoreSub:'points gagn√©s',
    pGames:'PARTIES JOU√âES',pStreak:'MEILLEURE S√âRIE',pRow:"d'affil√©e",
    pAcc:'PR√âCISION GLOBALE',pBadges:'BADGES OBTENUS',pReset:'R√©initialiser',
    nextQ:'Suivant ‚ûú',seeResults:'Voir les r√©sultats',
    badgeNames:{first:'Premiers Pas',streak3:'En feu',perfect:'Parfait !',hard:'Champion',medium:'√ârudit',easy:'D√©butant'},
  },
  es:{
    tagline:"¬°Aprende la hora ‚Äî es divertido! ‚≠ê",
    easy:'F√°cil',easyDesc:'Solo horas enteras',
    medium:'Medio',mediumDesc:'Medias y cuartos de hora',
    hard:'Dif√≠cil',hardDesc:'¬°Cualquier minuto ‚Ä¢ Cronometrado!',
    parent:'Padres',practice:'Practicar',
    fpTitle:'Pr√°ctica libre',fpDrag:'¬°Arrastra las manecillas!',
    whatTime:'¬øQu√© hora muestra el reloj?',
    correct:['¬°Muy bien! üéâ','¬°Incre√≠ble! ‚≠ê','¬°Lo lograste! üôå','¬°Fant√°stico! üåü','¬°Brillante! üí°'],
    wrong:['¬°Int√©ntalo de nuevo! üí™','¬°Casi! ¬°Sigue as√≠!','¬°T√∫ puedes! ü§©','¬°Muy cerca! üéØ'],
    q:'Pregunta',of:'de',
    resAcc:'Precisi√≥n',resStreak:'Mejor racha',resAnswered:'Respondidas',
    resBadgeHdr:'¬°Insignia desbloqueada!',resHome:'Inicio',resAgain:'Jugar de nuevo',
    resTitles:['¬°Sigue practicando!','¬°Buen esfuerzo!','¬°Buen trabajo!','¬°Incre√≠ble!','¬°Perfecto! üåü'],
    resPts:'pts',
    parentTitle:'üë®‚Äçüë©‚Äçüëß Panel de Padres',
    pScore:'PUNTUACI√ìN TOTAL',pScoreSub:'puntos ganados',
    pGames:'PARTIDAS JUGADAS',pStreak:'MEJOR RACHA',pRow:'seguidas',
    pAcc:'PRECISI√ìN GLOBAL',pBadges:'INSIGNIAS GANADAS',pReset:'Restablecer',
    nextQ:'Siguiente ‚ûú',seeResults:'Ver resultados',
    badgeNames:{first:'Primeros pasos',streak3:'En llamas',perfect:'¬°Perfecto!',hard:'Campe√≥n',medium:'Erudito',easy:'Principiante'},
  },
  ar:{
    tagline:"ÿ™ÿπŸÑŸÖ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ≥ÿßÿπÿ© ‚Äî ÿ•ŸÜŸá ŸÖŸÖÿ™ÿπ! ‚≠ê",
    easy:'ÿ≥ŸáŸÑ',easyDesc:'ÿ≥ÿßÿπÿßÿ™ ŸÉÿßŸÖŸÑÿ© ŸÅŸÇÿ∑',
    medium:'ŸÖÿ™Ÿàÿ≥ÿ∑',mediumDesc:'ŸÜÿµŸÅ Ÿàÿ±ÿ®ÿπ ÿßŸÑÿ≥ÿßÿπÿ©',
    hard:'ÿµÿπÿ®',hardDesc:'ÿ£Ÿä ÿØŸÇŸäŸÇÿ© ‚Ä¢ ŸÖŸàŸÇŸàÿ™!',
    parent:'ÿßŸÑŸàÿßŸÑÿØÿßŸÜ',practice:'ÿ™ÿØÿ±Ÿäÿ®',
    fpTitle:'ÿ™ÿØÿ±Ÿäÿ® ÿ≠ÿ±',fpDrag:'ÿßÿ≥ÿ≠ÿ® ÿπŸÇÿßÿ±ÿ® ÿßŸÑÿ≥ÿßÿπÿ©!',
    whatTime:'ŸÖÿß ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ∞Ÿä ÿ™Ÿèÿ∏Ÿáÿ±Ÿá ÿßŸÑÿ≥ÿßÿπÿ©ÿü',
    correct:['ÿ£ÿ≠ÿ≥ŸÜÿ™! üéâ','ÿ±ÿßÿ¶ÿπ! ‚≠ê','ÿ£ÿµÿ®ÿ™! üôå','ŸÖŸÖÿ™ÿßÿ≤! üåü','ÿ®ÿßÿ±ÿπ! üí°'],
    wrong:['ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ! üí™','ÿ™ŸÇÿ±Ÿäÿ®ÿßŸã! ÿßÿ≥ÿ™ŸÖÿ±!','ÿ£ŸÜÿ™ ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ! ü§©','ŸÇÿ±Ÿäÿ® ÿ¨ÿØÿßŸã! üéØ'],
    q:'ÿ≥ÿ§ÿßŸÑ',of:'ŸÖŸÜ',
    resAcc:'ÿßŸÑÿØŸÇÿ©',resStreak:'ÿ£ŸÅÿ∂ŸÑ ÿ≥ŸÑÿ≥ŸÑÿ©',resAnswered:'ÿ£Ÿèÿ¨Ÿäÿ®',
    resBadgeHdr:'ÿ¥ÿßÿ±ÿ© ÿ¨ÿØŸäÿØÿ©!',resHome:'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',resAgain:'ÿßŸÑÿπÿ® ŸÖÿ¨ÿØÿØÿßŸã',
    resTitles:['ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ™ÿØÿ±Ÿäÿ®!','ÿ¨ŸáÿØ ÿ¨ŸäÿØ!','ÿπŸÖŸÑ ÿ±ÿßÿ¶ÿπ!','ŸÖÿ∞ŸáŸÑ!','ŸÖÿ´ÿßŸÑŸä! üåü'],
    resPts:'ŸÜŸÇÿ∑ÿ©',
    parentTitle:'üë®‚Äçüë©‚Äçüëß ŸÑŸàÿ≠ÿ© ÿßŸÑŸàÿßŸÑÿØŸäŸÜ',
    pScore:'ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÜŸÇÿßÿ∑',pScoreSub:'ŸÜŸÇÿßÿ∑ ŸÖŸÉÿ™ÿ≥ÿ®ÿ©',
    pGames:'ÿßŸÑÿ£ŸÑÿπÿßÿ® ÿßŸÑŸÖŸÑÿπŸàÿ®ÿ©',pStreak:'ÿ£ŸÅÿ∂ŸÑ ÿ≥ŸÑÿ≥ŸÑÿ©',pRow:'ŸÖÿ™ÿ™ÿßŸÑŸäÿ©',
    pAcc:'ÿßŸÑÿØŸÇÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©',pBadges:'ÿßŸÑÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸÉÿ™ÿ≥ÿ®ÿ©',pReset:'ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ',
    nextQ:'ÿßŸÑÿ™ÿßŸÑŸä ‚ûú',seeResults:'ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨',
    badgeNames:{first:'ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸâ',streak3:'ŸÖŸÑÿ™Ÿáÿ®',perfect:'ŸÖÿ´ÿßŸÑŸä!',hard:'ÿ®ÿ∑ŸÑ',medium:'ÿπÿßŸÑŸÖ',easy:'ŸÖÿ®ÿ™ÿØÿ¶'},
  },
};

let currentLang='en';
function T(k){return (LANGS[currentLang]||{})[k]||(LANGS.en||{})[k]||k;}
function $(id){return document.getElementById(id);}

function setLang(l,btn){
  currentLang=l;
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  document.dir=l==='ar'?'rtl':'ltr';
  applyTranslations();
}

function applyTranslations(){
  const l=LANGS[currentLang];
  // Home
  $('home-tagline').textContent=l.tagline;
  $('lbl-easy').textContent=l.easy;$('lbl-easy-desc').textContent=l.easyDesc;
  $('lbl-medium').textContent=l.medium;$('lbl-medium-desc').textContent=l.mediumDesc;
  $('lbl-hard').textContent=l.hard;$('lbl-hard-desc').textContent=l.hardDesc;
  $('lbl-parent').textContent=l.parent;$('lbl-practice').textContent=l.practice;
  // Free play
  $('lbl-fp-title').textContent=l.fpTitle;$('lbl-fp-drag').textContent=l.fpDrag;
  // Result labels
  $('res-lbl-acc').textContent=l.resAcc;$('res-lbl-streak').textContent=l.resStreak;
  $('res-lbl-answered').textContent=l.resAnswered;
  $('res-badge-hdr').textContent=l.resBadgeHdr;
  $('res-btn-home').textContent=l.resHome;$('res-btn-again').textContent=l.resAgain;
  // Parent labels
  $('parent-title').textContent=l.parentTitle;
  $('p-lbl-score').textContent=l.pScore;$('p-lbl-score-sub').textContent=l.pScoreSub;
  $('p-lbl-games').textContent=l.pGames;$('p-lbl-streak').textContent=l.pStreak;
  $('p-lbl-row').textContent=l.pRow;$('p-lbl-acc').textContent=l.pAcc;
  $('p-lbl-badges').textContent=l.pBadges;$('p-btn-reset').textContent=l.pReset;
  // Re-render badge grid if parent screen visible
  if($('screen-parent').classList.contains('active'))renderBadges();
}

// =====================================================================
// 100-QUESTION POOL GENERATOR per level
// =====================================================================
function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}

function makeEasyPool(){
  // 12 hours √ó every possible whole hour, 8-9 entries each = 100+
  const pool=[];
  for(let rep=0;rep<9;rep++){
    for(let h=0;h<12;h++) pool.push({h,m:0});
  }
  return shuffle(pool).slice(0,100);
}

function makeMediumPool(){
  const pool=[];const mins=[0,15,30,45];
  for(let rep=0;rep<3;rep++){
    for(let h=0;h<12;h++){
      for(const m of mins) pool.push({h,m});
    }
  }
  return shuffle(pool).slice(0,100);
}

function makeHardPool(){
  // Curated set: every 5-min mark for all hours, plus random fill
  const pool=[];
  for(let h=0;h<12;h++){
    for(let m=0;m<60;m+=5) pool.push({h,m});
  }
  // random minutes to fill to 100
  while(pool.length<100){
    pool.push({h:Math.floor(Math.random()*12),m:Math.floor(Math.random()*60)});
  }
  return shuffle(pool).slice(0,100);
}

let POOLS={easy:[],medium:[],hard:[]};
function refreshPools(){
  POOLS.easy=makeEasyPool();
  POOLS.medium=makeMediumPool();
  POOLS.hard=makeHardPool();
}
refreshPools();

function pickQuestions(level,count=10){
  return shuffle(POOLS[level]).slice(0,count);
}

// =====================================================================
// STATE & PERSISTENCE
// =====================================================================
const BADGES_DEF=[
  {id:'first',emoji:'üåü',nameKey:'first'},
  {id:'streak3',emoji:'üî•',nameKey:'streak3'},
  {id:'perfect',emoji:'üíé',nameKey:'perfect'},
  {id:'hard',emoji:'üèÜ',nameKey:'hard'},
  {id:'medium',emoji:'ü•à',nameKey:'medium'},
  {id:'easy',emoji:'ü•â',nameKey:'easy'},
];

let state={
  level:'easy',score:0,streak:0,bestStreak:0,
  questionsAnswered:0,correctCount:0,
  sessionQuestions:[],currentQIndex:0,
  targetTime:null,answered:false,_lastBadge:null,
  // persistent
  totalScore:0,totalGames:0,totalCorrect:0,totalAnswered:0,
  globalBestStreak:0,unlockedBadges:[],
};

function loadProgress(){try{const s=localStorage.getItem('ticktock_progress');if(s)Object.assign(state,JSON.parse(s));}catch(e){}}
function saveProgress(){try{localStorage.setItem('ticktock_progress',JSON.stringify({totalScore:state.totalScore,totalGames:state.totalGames,totalCorrect:state.totalCorrect,totalAnswered:state.totalAnswered,globalBestStreak:state.globalBestStreak,unlockedBadges:state.unlockedBadges}));}catch(e){}}
function resetProgress(){
  if(!confirm(T('pReset')+'?'))return;
  Object.assign(state,{totalScore:0,totalGames:0,totalCorrect:0,totalAnswered:0,globalBestStreak:0,unlockedBadges:[]});
  saveProgress();showParent();
}
loadProgress();

// =====================================================================
// NAVIGATION
// =====================================================================
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));$('screen-'+id).classList.add('active');}
function goHome(){showScreen('home');}

function showParent(){
  showScreen('parent');
  $('pTotalScore').textContent=state.totalScore;
  $('pGames').textContent=state.totalGames;
  $('pStreak').textContent=state.globalBestStreak;
  const acc=state.totalAnswered>0?Math.round(state.totalCorrect/state.totalAnswered*100):0;
  $('pAccuracy').textContent=acc+'%';
  $('pAccuracyBar').style.width=acc+'%';
  renderBadges();
}

function renderBadges(){
  const l=LANGS[currentLang];
  $('badgeGrid').innerHTML=BADGES_DEF.map(b=>{
    const name=(l.badgeNames||{})[b.nameKey]||b.nameKey;
    return `<div class="badge-item ${state.unlockedBadges.includes(b.id)?'earned':''}"><div class="b-emoji">${b.emoji}</div><div class="b-name">${name}</div></div>`;
  }).join('');
}

// =====================================================================
// CLOCK DRAWING
// =====================================================================
const TAU=Math.PI*2;

function drawClock(canvas,hour,minute,size){
  const ctx=canvas.getContext('2d');
  const cx=size/2,cy=size/2,r=size/2-8;
  ctx.clearRect(0,0,size,size);
  // Shadow
  ctx.save();ctx.shadowBlur=26;ctx.shadowColor='rgba(91,79,233,.22)';ctx.shadowOffsetY=7;
  ctx.beginPath();ctx.arc(cx,cy,r,0,TAU);ctx.fillStyle='#fff';ctx.fill();ctx.restore();
  // Face
  const g=ctx.createRadialGradient(cx-r*.2,cy-r*.2,0,cx,cy,r);
  g.addColorStop(0,'#fff');g.addColorStop(1,'#EEF2FF');
  ctx.beginPath();ctx.arc(cx,cy,r,0,TAU);ctx.fillStyle=g;ctx.fill();
  // Rim
  ctx.beginPath();ctx.arc(cx,cy,r,0,TAU);
  ctx.strokeStyle='#5B4FE9';ctx.lineWidth=size>240?7:5;ctx.stroke();
  // Ticks
  for(let i=0;i<60;i++){
    const a=i/60*TAU-Math.PI/2,isH=i%5===0;
    const inner=r-(isH?(size>240?25:19):(size>240?14:11));
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(a)*inner,cy+Math.sin(a)*inner);
    ctx.lineTo(cx+Math.cos(a)*(r-7),cy+Math.sin(a)*(r-7));
    ctx.strokeStyle=isH?'#3949AB':'#9FA8DA';ctx.lineWidth=isH?2.5:1.2;ctx.lineCap='round';ctx.stroke();
  }
  // Numbers
  const fs=size>240?17:14;
  ctx.font=`bold ${fs}px 'Fredoka',sans-serif`;
  ctx.fillStyle='#1A237E';ctx.textAlign='center';ctx.textBaseline='middle';
  for(let n=1;n<=12;n++){
    const a=n/12*TAU-Math.PI/2,nr=r-(size>240?40:32);
    ctx.fillText(n,cx+Math.cos(a)*nr,cy+Math.sin(a)*nr);
  }
  // Hour hand
  const ha=((hour%12)+minute/60)/12*TAU-Math.PI/2;
  drawHand(ctx,cx,cy,ha,r*.52,size>240?8:6,'#1A237E','#3949AB');
  // Minute hand
  const ma=minute/60*TAU-Math.PI/2;
  drawHand(ctx,cx,cy,ma,r*.72,size>240?5:4,'#5C6BC0','#7986CB');
  // Center
  ctx.beginPath();ctx.arc(cx,cy,size>240?9:7,0,TAU);ctx.fillStyle='#FF6B6B';ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,size>240?4:3,0,TAU);ctx.fillStyle='white';ctx.fill();
}

function drawHand(ctx,cx,cy,angle,len,width,color,glow){
  ctx.save();ctx.shadowBlur=6;ctx.shadowColor=glow;
  ctx.beginPath();
  ctx.moveTo(cx+Math.cos(angle+Math.PI)*len*.17,cy+Math.sin(angle+Math.PI)*len*.17);
  ctx.lineTo(cx+Math.cos(angle)*len,cy+Math.sin(angle)*len);
  ctx.strokeStyle=color;ctx.lineWidth=width;ctx.lineCap='round';ctx.stroke();
  ctx.restore();
}

// =====================================================================
// QUIZ LOGIC
// =====================================================================
function formatTime(h,m){const hd=h===0?12:h;return hd+':'+String(m).padStart(2,'0');}

function timeWords(h,m){
  const names=['twelve','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve'];
  const hd=h===0?12:h;
  if(m===0)return `${names[hd]} o'clock`;
  if(m===15)return `quarter past ${names[hd]}`;
  if(m===30)return `half past ${names[hd]}`;
  if(m===45)return `quarter to ${names[hd===12?1:hd+1]}`;
  return `${names[hd]} ${m<10?'oh '+m:m}`;
}

function generateChoices(correct,level){
  const pool=POOLS[level];
  const choices=[correct];
  let tries=0;
  while(choices.length<4&&tries<300){
    tries++;
    const c=pool[Math.floor(Math.random()*pool.length)];
    if(!choices.some(x=>x.h===c.h&&x.m===c.m)) choices.push(c);
  }
  while(choices.length<4) choices.push({h:Math.floor(Math.random()*12),m:Math.floor(Math.random()*60)});
  return shuffle(choices);
}

function startGame(level){
  refreshPools();
  Object.assign(state,{level,score:0,streak:0,bestStreak:0,questionsAnswered:0,correctCount:0,answered:false,_lastBadge:null,currentQIndex:0});
  state.sessionQuestions=pickQuestions(level,10);
  state.totalGames++;saveProgress();
  showScreen('quiz');renderQuestion();
}

function renderQuestion(){
  const qi=state.currentQIndex,total=state.sessionQuestions.length;
  state.targetTime=state.sessionQuestions[qi];state.answered=false;
  const l=LANGS[currentLang];
  $('questionLabel').textContent=`${l.q} ${qi+1} ${l.of} ${total}`;
  $('progressBar').style.width=(qi/total*100)+'%';
  $('scoreDisplay').textContent=state.score;$('streakDisplay').textContent=state.streak;
  $('questionText').textContent=l.whatTime;
  drawClock($('clock'),state.targetTime.h,state.targetTime.m,240);
  const choices=generateChoices(state.targetTime,state.level);
  $('choicesContainer').innerHTML=`<div class="choices-grid">${choices.map(c=>`<button class="btn-choice-grid" onclick="submitAnswer(${c.h},${c.m},this)">${formatTime(c.h,c.m)}</button>`).join('')}</div>`;
  $('nextBtnWrap').style.display='none';
}

function nextQuestion(){
  state.currentQIndex++;
  if(state.currentQIndex>=state.sessionQuestions.length) showResult();
  else renderQuestion();
}

function submitAnswer(h,m,btn){
  if(state.answered)return;
  state.answered=true;state.questionsAnswered++;state.totalAnswered++;
  const correct=state.targetTime.h===h&&state.targetTime.m===m;
  const l=LANGS[currentLang];
  if(correct){
    btn.classList.add('correct');
    const pts=10*(state.streak+1);state.score+=pts;state.streak++;
    state.bestStreak=Math.max(state.bestStreak,state.streak);
    state.globalBestStreak=Math.max(state.globalBestStreak,state.streak);
    state.correctCount++;state.totalCorrect++;state.totalScore+=pts;
    showToast(l.correct[Math.floor(Math.random()*l.correct.length)],true);
    if(state.correctCount===1)unlockBadge('first');
    if(state.streak>=3)unlockBadge('streak3');
    launchConfetti();
  }else{
    btn.classList.add('wrong');state.streak=0;
    showToast(l.wrong[Math.floor(Math.random()*l.wrong.length)],false);
    document.querySelectorAll('.btn-choice-grid').forEach(b=>{
      if(b.textContent.trim()===formatTime(state.targetTime.h,state.targetTime.m))
        setTimeout(()=>b.classList.add('correct'),300);
    });
  }
  $('scoreDisplay').textContent=state.score;$('streakDisplay').textContent=state.streak;
  document.querySelectorAll('.btn-choice-grid').forEach(b=>{
    if(!b.classList.contains('correct')&&!b.classList.contains('wrong')){b.style.opacity='.42';b.style.pointerEvents='none';}
  });
  const isLast=state.currentQIndex>=state.sessionQuestions.length-1;
  $('nextBtnWrap').style.display='block';
  $('nextBtn').textContent=isLast?l.seeResults:l.nextQ;
  saveProgress();
}

function showResult(){
  const total=state.sessionQuestions.length;
  const acc=Math.round(state.correctCount/total*100);
  const l=LANGS[currentLang];
  const ti=acc>=95?4:acc>=80?3:acc>=60?2:acc>=40?1:0;
  const emojis=['üí™','üòä','üéâ','üåü','‚ú®'];
  $('resultEmoji').textContent=emojis[ti];
  $('resultTitle').textContent=l.resTitles[ti];
  $('resultScore').textContent=state.score+' '+l.resPts;
  $('resultAccuracy').textContent=acc+'%';
  $('resultStreak').textContent=state.bestStreak;
  $('resultQuestions').textContent=total;
  $('progressBar').style.width='100%';
  // stat pill labels
  $('res-lbl-acc').textContent=l.resAcc;
  $('res-lbl-streak').textContent=l.resStreak;
  $('res-lbl-answered').textContent=l.resAnswered;
  $('res-btn-home').textContent=l.resHome;
  $('res-btn-again').textContent=l.resAgain;
  $('res-badge-hdr').textContent=l.resBadgeHdr;
  if(acc===100)unlockBadge('perfect');
  unlockBadge(state.level);
  $('badgeUnlocked').style.display='none';
  if(state._lastBadge){
    const b=BADGES_DEF.find(x=>x.id===state._lastBadge);
    if(b){
      const bname=(l.badgeNames||{})[b.nameKey]||b.nameKey;
      $('badgeUnlocked').style.display='flex';
      $('badgeEmoji').textContent=b.emoji;
      $('badgeName').textContent=bname;
    }
  }
  if(acc===100)launchConfetti(3000);
  showScreen('result');
}

function playAgain(){startGame(state.level);}

// =====================================================================
// FREE PLAY
// =====================================================================
let freeHour=12,freeMin=0,fpDragging=false;

function showFreePlay(){
  showScreen('freeplay');
  setTimeout(()=>{
    const c=$('clockFree');
    drawClock(c,freeHour,freeMin,270);updateFreeDisplay();setupFreePlayDrag(c);
  },60);
}

function updateFreeDisplay(){
  $('freeTimeDisplay').textContent=formatTime(freeHour===0?12:freeHour,freeMin);
  $('freeTimeWords').textContent=timeWords(freeHour,freeMin);
}

function setupFreePlayDrag(canvas){
  let draggingHand=null;const sz=270,cx=sz/2,cy=sz/2;
  const getPos=e=>{const r=canvas.getBoundingClientRect(),s=e.touches?e.touches[0]:e;return{x:s.clientX-r.left,y:s.clientY-r.top};};
  const start=e=>{
    e.preventDefault();const{x,y}=getPos(e);
    if(Math.hypot(x-cx,y-cy)<16)return;
    const ma=freeMin/60*TAU-Math.PI/2,ha=((freeHour%12)+freeMin/60)/12*TAU-Math.PI/2;
    const mx=cx+Math.cos(ma)*97,my=cy+Math.sin(ma)*97,hx=cx+Math.cos(ha)*68,hy=cy+Math.sin(ha)*68;
    draggingHand=Math.hypot(x-mx,y-my)<Math.hypot(x-hx,y-hy)?'minute':'hour';fpDragging=true;
  };
  const move=e=>{
    if(!fpDragging)return;e.preventDefault();const{x,y}=getPos(e);
    const norm=(Math.atan2(y-cy,x-cx)+Math.PI/2+TAU)%TAU;
    if(draggingHand==='minute')freeMin=Math.round(norm/TAU*60)%60;
    else freeHour=Math.round(norm/TAU*12)%12;
    drawClock(canvas,freeHour,freeMin,270);updateFreeDisplay();
  };
  const end=()=>{fpDragging=false;draggingHand=null;};
  canvas.onmousedown=start;canvas.onmousemove=move;canvas.onmouseup=end;
  canvas.ontouchstart=start;canvas.ontouchmove=move;canvas.ontouchend=end;
}

// =====================================================================
// BADGES
// =====================================================================
function unlockBadge(id){
  if(!state.unlockedBadges.includes(id)){state.unlockedBadges.push(id);state._lastBadge=id;saveProgress();}
}

// =====================================================================
// TOAST
// =====================================================================
function showToast(msg,ok){
  const t=$('feedbackToast');t.textContent=msg;
  t.className='feedback-toast '+(ok?'correct-fb':'wrong-fb');
  void t.offsetWidth;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1700);
}

// =====================================================================
// CONFETTI
// =====================================================================
const cc=$('confetti-canvas'),cx2=cc.getContext('2d');
cc.width=innerWidth;cc.height=innerHeight;
addEventListener('resize',()=>{cc.width=innerWidth;cc.height=innerHeight;});
let confetti=[],cActive=false,cEnd=0;
const COLS=['#5B4FE9','#FF6B6B','#FFD93D','#6BCB77','#4ECDC4','#FF8C42'];
function launchConfetti(dur=1400){
  for(let i=0;i<75;i++) confetti.push({x:Math.random()*cc.width,y:-10-Math.random()*100,r:4+Math.random()*8,d:2+Math.random()*3,color:COLS[Math.floor(Math.random()*COLS.length)],ta:0,ts:.05+Math.random()*.1,shape:Math.random()>.5?'c':'r'});
  cEnd=Date.now()+dur;if(!cActive){cActive=true;animConf();}
}
function animConf(){
  cx2.clearRect(0,0,cc.width,cc.height);
  confetti=confetti.filter(p=>p.y<cc.height+20);
  confetti.forEach(p=>{
    p.y+=p.d+1;p.x+=Math.sin(p.ta)*1.5;p.ta+=p.ts;
    cx2.beginPath();cx2.fillStyle=p.color;
    if(p.shape==='c'){cx2.arc(p.x,p.y,p.r,0,TAU);}
    else{cx2.save();cx2.translate(p.x,p.y);cx2.rotate(Math.sin(p.ta)*12*Math.PI/180);cx2.fillRect(-p.r,-p.r/2,p.r*2,p.r);cx2.restore();}
    cx2.fill();
  });
  if(Date.now()<cEnd||confetti.length>0)requestAnimationFrame(animConf);
  else{cActive=false;cx2.clearRect(0,0,cc.width,cc.height);}
}

// =====================================================================
// INIT
// =====================================================================
applyTranslations();
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('https://lamranimarouane-sketch.github.io/ticktocktales/sw.js', {
        scope: 'https://lamranimarouane-sketch.github.io/ticktocktales/'
      })
        .then(() => console.log('SW registered'))
        .catch(e => console.log('SW error', e));
    });
  }
</script>
</body>
</html>
